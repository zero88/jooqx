name: test
description: 'Analysis project'
inputs:
  profile:
    description: 'Build profile'
    required: true
  version:
    description: 'Project version'
    required: true
  semanticVersion:
    description: 'Project semantic version'
    required: true
  hashVersion:
    description: 'Project hash commit'
    required: true
  branch:
    description: 'Git branch'
    required: true
  github-token:
    description: 'GitHub Token'
    required: true
  sonar-token:
    description: 'Sonar Token'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        distribution: microsoft
        java-version: 11

    - name: Cache SonarCloud packages
      uses: actions/cache@v2.1.4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: Cache Gradle packages
      uses: actions/cache@v2.1.4
      with:
        path: ~/.gradle/caches
        key: ${{ runner.os }}-gradle-test-${{ hashFiles('**/*.gradle.kts') }}
        restore-keys: ${{ runner.os }}-gradle-test

    - name: Generate jOOQ
      shell: bash
      run: ./generateJooq.sh

    - name: Test
      shell: bash
      run: ./gradlew jacocoRootReport

    - name: SonarQube
      shell: bash
      run: ./gradlew sonarqube -x jacocoRootReport -Dsonar.login=${{ inputs.sonar-token }} -Dsonar.branch.name=${{ inputs.branch }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
